#!/bin/bash --login

LIB_PATH=$( dirname $0 )/../lib/script
source $LIB_PATH/script_helper.sh

# argument one: our entry point, index.html
ENTRY_POINT_JS=$( abs_path $1 )

# argument two: our project folder. defaults to current path
if [ ! -z $2 ]; then
  PROJECT_PATH=$( abs_path $2 )
else
#  PROJECT_PATH=$( dirname $ENTRY_POINT_JS )
  PROJECT_PATH=$USER_PATH
fi

# argument three: an optional build id. defaults to our generic build.
if [ ! -z $3 ]; then
  BUILD_ID=$3
else
  BUILD_ID=$( build_id )
fi


TMP_PATH=$TMP_PATH/$BUILD_ID

# make ourselves at home.
rm --recursive --force $TMP_PATH
mkdir --verbose --parent $TMP_PATH


# output package is our input html with a .nw output.
OUTPUT_PACKAGE_NAME=$TMP_PATH/$( basename $ENTRY_POINT_JS .js )-$BUILD_ID.nw


# ===== BUILD
  APP_LOADER=$LIB_PATH/../app_loader.html

  # copy assets into build folder.
  #cp --recursive --verbose --dereference --force $RES_PATH/nwjs/* $TMP_PATH/

  # copy user entry point into build folder.
  cp --recursive --verbose --dereference --force $ENTRY_POINT_JS $TMP_PATH/

  # copy user project into build folder.
  cp --recursive --verbose --dereference --force $PROJECT_PATH/* $TMP_PATH/

  # copy our libs, if any, into build folder.
  if [ ! -d $TMP_PATH/lib/ ]; then    mkdir --verbose --parent $TMP_PATH/lib;   fi
  cp --recursive --verbose --dereference --force $LIB_PATH/../* $TMP_PATH/lib/
  cp --recursive --verbose --dereference --force $APP_LOADER $TMP_PATH/

  # copy our package.json in if the user has none.
  if [ ! -f $TMP_PATH/package.json ]; then
    cp --verbose --dereference $RES_PATH/build/default_package.json $TMP_PATH/package.json
  fi

# ===== PACKAGE IT!
  cd $TMP_PATH
  zip -9 -r -o -b $USER_PATH $OUTPUT_PACKAGE_NAME ./* 
  #cp --recursive --verbose --force $OUTPUT_PACKAGE_NAME $USER_PATH

# ===== SHIP IT!
  echo -e -n $BUILD_ID > $TMP_PATH/../.$( basename $ENTRY_POINT_JS .js ).recent_build
  cd $USER_PATH
  exit $EXITCODE_SUCCESS
